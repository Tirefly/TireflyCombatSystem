# TCS 后续改进细节（Backlog）

本文件用于记录 TireflyCombatSystem（TCS）插件的“设计待办 / 技术债 / 可选增强点”，方便阶段性统一处理与回归验证。

---

### 1.4 对象池回收（等待 TireflyObjectPool 重构，与 TireflyObjectPool 重构对齐）

**现状**
- StateInstance 的回收仍有 TODO，等待 TireflyObjectPool 插件 API 稳定。

**状态**
- 暂缓：等待 TOP（TireflyObjectPool）升级/重构完成后再统一落地。

**待办（预留）**
- 统一“合并移除 / 正常移除 / 过期移除 / 取消移除”的回收路径；
- 确保回收前：
  - 已从 `StateInstanceIndex` / `DurationTracker` / `StateTreeTickScheduler` / `StateSlotsX` 清理；
  - StateTree 已停止推进（并确保不会继续收到 tick）。

---

## 2. Attribute 模块

### 2.1 SourceHandle（已完成）

SourceHandle 已在 Attribute 模块落地，用于统一追踪效果来源，并支持按来源查询/撤销：

- `FTcsSourceHandle`（支持 `NetSerialize`）
- `FTcsAttributeModifierInstance::SourceHandle`
- `FTcsAttributeChangeEventPayload::ChangeSourceRecord`：`TMap<FTcsSourceHandle, float>`
- `UTcsAttributeManagerSubsystem`：
  - `CreateSourceHandle / CreateSourceHandleSimple`
  - `ApplyModifierWithSourceHandle / RemoveModifiersBySourceHandle / GetModifiersBySourceHandle`

**参考文档**
- 使用指南：`Plugins/TireflyCombatSystem/Documents/SourceHandle使用指南.md`
- 机制说明：`Plugins/TireflyCombatSystem/Documents/文档：SourceHandle机制设计与落地方案.md`
- OpenSpec：`Plugins/TireflyCombatSystem/openspec/changes/implement-source-handle/`

---

## 3. 工程性改进（通用）

### 3.2 自动化测试（后续）

**范围定位**
- 只覆盖“核心不变量”和“容易回归的边界行为”，避免测试与示例资产强耦合。

**建议用例（State）**
- `RemovalRequest`：
  - 申请后，`bPendingRemovalRequest` 为 true，且不会立刻从 Slot 清理；
  - StateTree 停止后，实例被 `FinalizeStateRemoval` 清理（Index/Scheduler/Duration/Slot 一致）。
- `DurationTickPolicy`：
  - `DTP_ActiveOnly`：Inactive/HangUp/Pause 不消耗（Pause 受 `bFreezeDurationWhenPaused` 控制）；
  - `DTP_Always`：除非 Pause 冻结，否则所有阶段按策略递减。
- `ActivationMode + Gate`：
  - Gate 关闭时，不允许出现 `SS_Active` 残留；
  - PriorityOnly 下最高优先级为 Active（非 PendingRemoval）。

**建议用例（Attribute）**
- `MergeAttributeModifiers`：
  - `MergerType == nullptr` 时不丢失 modifier（保留所有实例）。
- `Priority`：
  - 优先级“值越大越先执行”的排序正确。
- `ReachedBoundary`：
  - Old/New/BoundaryValue 信息完整且数值正确。

**落地位置**
- `Source/TireflyCombatSystem/Private/Tests`（按模块约定放置）。
