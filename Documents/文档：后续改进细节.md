# TCS 后续改进细节（Backlog）

本文件用于记录 TireflyCombatSystem（TCS）插件的“设计待办 / 技术债 / 可选增强点”，方便阶段性统一处理与回归验证。

---

## 1. State 模块

### 1.1 Pause 阶段的持续时间策略可配置

**背景**
- 当前实现里 `SS_Pause` 默认“强冻结”持续时间，这会覆盖 `ETcsDurationTickPolicy` 的设计初衷：Duration 递减应主要由 StateSlot 的策略决定。

**目标**
- 让开发者可选择：Pause 阶段是否冻结 Duration。

**建议方案（可直接实现 / 已落地基础开关）**
- 在 `FTcsStateSlotDefinition` 增加 `bFreezeDurationWhenPaused`（默认 `true`）。
  - `true`：保持“Pause 强冻结”语义（当前默认行为）。
  - `false`：Pause 阶段也遵循 `DurationTickPolicy`。

**后续可增强**
- 若未来需要更细粒度控制，可把 bool 升级为枚举：例如 `Freeze / FollowPolicy / AlwaysTick`。

---

### 1.2 RemovalRequest 流程进一步简化（StateTree 驱动确认）

**现状**
- C++ 侧通过 `RequestStateRemoval` 发送 RemovalRequested 事件并调度 Tick；
- 最终移除由 `FinalizeStateRemoval` 完成（从容器/Slot 移除、广播事件等）；
- 为保证自由度，不强制超时强制移除，仅做 warning。

**问题**
- 对于希望“所有取消/过期逻辑都在 StateTree 内部完成”的项目，当前流程仍要求开发者在 StateTree 里自行处理“什么时候停止运行”的时机与方式。

**建议方案（可直接实现）**
- 提供一个可选的 StateTree Task（或 Evaluator/Task 组合），让开发者显式在 StateTree 图里落点：
  - Task 名称示例：`TcsStateTreeTask_ConfirmRemoval` / `TcsStateTreeTask_StopForRemoval`
  - 参数示例：`bCancelled`（或 `Reason` 枚举：Removed/Cancelled/Expired/Custom）
  - 任务职责：
    - 通知 `StateInstance`：本实例已经进入“可停止/可清理”阶段；
    - 触发 StateTree 结束（或停止 tick + 让系统进入 finalize）。

**注意**
- 该 Task 只是“选项”，不强制项目必须使用；符合 TCS “自由度优先”的设计理念。

---

### 1.4 对象池回收（与 TireflyObjectPool 重构对齐）

**现状**
- StateInstance 的回收仍有 TODO，等待 TireflyObjectPool 插件 API 稳定。

**状态**
- 暂缓：等待 TOP（TireflyObjectPool）升级/重构完成后再统一落地。

**待办（预留）**
- 统一“合并移除 / 正常移除 / 过期移除 / 取消移除”的回收路径；
- 确保回收前：
  - 已从 `StateInstanceIndex` / `DurationTracker` / `StateTreeTickScheduler` / `StateSlotsX` 清理；
  - StateTree 已停止推进（并确保不会继续收到 tick）。

---

## 2. Attribute 模块

### 2.1 Source 机制升级为 SourceHandle（推荐）

**现状**
- `FTcsAttributeModifierInstance` 只有 `SourceName(FName)` + `Instigator/Target`：
  - 可用于事件归因（`ChangeSourceRecord`）；
  - 但不适合做“生命周期管理”（撤销某个来源、引用计数、跨系统统一）。

**问题**
- `SourceName` 不保证唯一；
- 无法表达“同一个技能来源的多次应用/多层叠加”的唯一实例；
- 无法与未来的对象池回收、技能状态、buff 解除等流程形成统一的“来源归属”机制。

**执行文档**
- 详见：`Plugins/TireflyCombatSystem/Documents/文档：SourceHandle机制设计与落地方案.md`

---

## 3. 工程性改进（通用）

### 3.1 Debug Snapshot / 日志一致性

**目标**
- 为“线上/联机/复杂技能链”提供可复现、可定位、可对比的输出能力（不依赖断点）。

**统一字段（建议最少集合）**
- State：`StateDefId`、`InstanceId`、`Owner`、`Instigator`、`SlotTag`、`Stage`、`Priority`、`Level`、`StackCount`、`DurationType`、`DurationRemaining`、`TickPolicy`、`bGateOpen`、`bPendingRemovalRequest`、`PendingRemovalReason`
- Attribute：`AttributeName`、`OldValue/NewValue`、`SourceName` 或 `SourceHandle`、`ModifierName`、`ModifierInstId`、`Priority`、`Instigator/Target`

**建议实现点**
- 在 `UTcsStateComponent::GetSlotDebugSnapshot` 的输出中追加“Removal/Pending/Duration/TickPolicy”字段，并确保格式稳定（可做 diff）。
- 为 State 增加一个“全量快照”方法（建议 `BlueprintPure`）：
  - `GetStateDebugSnapshot(FName StateDefIdFilter = NAME_None)`：输出全量实例列表 + 每个 Slot 的 gate/stage 分布。
  - 输出建议兼容日志与 UI：单行摘要 + 可选多行详细。
- 统一日志入口：
  - 仅在“状态转换/容器变更/申请移除/最终移除/合并”这些关键点输出 `Verbose` 或 `Log`；
  - `Warning/Error` 必须包含：`Owner/StateDefId/InstanceId/SlotTag/Stage`。

**回归验证清单**
- Apply/Cancel/Expire/Remove/RemoveAll 路径产生的日志字段一致；
- PendingRemoval warning 只触发一次（避免刷屏）。

### 3.2 自动化测试（后续）

**范围定位**
- 只覆盖“核心不变量”和“容易回归的边界行为”，避免测试与示例资产强耦合。

**建议用例（State）**
- `RemovalRequest`：
  - 申请后，`bPendingRemovalRequest` 为 true，且不会立刻从 Slot 清理；
  - StateTree 停止后，实例被 `FinalizeStateRemoval` 清理（Index/Scheduler/Duration/Slot 一致）。
- `DurationTickPolicy`：
  - `DTP_ActiveOnly`：Inactive/HangUp/Pause 不消耗（Pause 受 `bFreezeDurationWhenPaused` 控制）；
  - `DTP_Always`：除非 Pause 冻结，否则所有阶段按策略递减。
- `ActivationMode + Gate`：
  - Gate 关闭时，不允许出现 `SS_Active` 残留；
  - PriorityOnly 下最高优先级为 Active（非 PendingRemoval）。

**建议用例（Attribute）**
- `MergeAttributeModifiers`：
  - `MergerType == nullptr` 时不丢失 modifier（保留所有实例）。
- `Priority`：
  - 优先级“值越大越先执行”的排序正确。
- `ReachedBoundary`：
  - Old/New/BoundaryValue 信息完整且数值正确。

**落地位置**
- `Source/TireflyCombatSystem/Private/Tests`（按模块约定放置）。
